<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Session Polar Clock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .polar-clock {
            transform: rotate(-90deg);
        }
        .tooltip {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 3px;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div id="app" class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-800">Таймер сессии КПТ</h1>
        
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                <!-- Polar Clock Visualization -->
                <div class="relative w-64 h-64 mx-auto md:mx-0">
                    <svg viewBox="0 0 100 100" class="polar-clock w-full h-full">
                        <path v-for="(stage, index) in stagesWithAngles" 
                              :d="getPathString(stage.startAngle, stage.endAngle)" 
                              :fill="currentStageIndex === index ? stage.activeColor : stage.color" 
                              stroke="white" 
                              stroke-width="0.5"
                              @mouseover="showTooltip(stage, $event)"
                              @mouseleave="hideTooltip"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none" style="transform: rotate(90deg);">
                        <span class="text-lg font-semibold text-gray-800">{{ currentStageName }}</span>
                        <span class="text-2xl font-bold text-gray-900">{{ formatTime(remainingTimeInStage) }}</span>
                    </div>
                </div>
                
                <!-- Stage Information -->
                <div class="flex-1">
                    <h2 class="text-xl font-semibold mb-4 text-blue-700">Этапы сессии:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div v-for="(stage, index) in stages" :key="index"
                             class="flex items-center p-2 rounded"
                             :class="{'ring-2 ring-blue-500 font-bold': currentStageIndex === index}">
                            <div class="w-4 h-4 rounded-full mr-2" :class="stage.color"></div>
                            <span class="text-sm">{{ stage.name }}</span>
                            <span class="ml-auto text-xs text-gray-500">{{ formatTime(stage.duration) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls and Progress -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex flex-col items-center">
                <div class="flex space-x-4 mb-6">
                    <button @click="startTimer" :disabled="isRunning" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-green-300">
                        <i class="fas fa-play mr-2"></i>Старт
                    </button>
                    <button @click="pauseTimer" :disabled="!isRunning" 
                            class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:bg-yellow-300">
                        <i class="fas fa-pause mr-2"></i>Пауза
                    </button>
                    <button @click="resetTimer" 
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        <i class="fas fa-redo mr-2"></i>Сброс
                    </button>
                </div>
                
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div class="bg-blue-600 h-4 rounded-full transition-all duration-1000" 
                         :style="{ width: progress + '%' }"></div>
                </div>
                
                <div class="text-lg font-semibold text-gray-700">
                    Общее время: {{ formatTime(currentTime) }} / {{ formatTime(totalTime) }}
                </div>
            </div>
        </div>
        
        <div v-if="tooltipVisible" class="tooltip" :style="{ left: tooltipX + 'px', top: tooltipY + 'px' }">
            {{ tooltipText }}
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onUnmounted } = Vue;
        
        createApp({
            setup() {
                // Состояние таймера
                const totalTime = ref(3000); // 50 минут в секундах
                const currentTime = ref(0);
                const isRunning = ref(false);
                const timer = ref(null);
                
                // Этапы сессии КПТ
                const stages = ref([
                    { name: 'Проверка настроения/медикаментов', duration: 300, color: 'bg-blue-200', activeColor: '#93c5fd' },
                    { name: 'Составление повестки', duration: 300, color: 'bg-blue-300', activeColor: '#60a5fa' },
                    { name: 'Обзор плана действий', duration: 300, color: 'bg-blue-400', activeColor: '#3b82f6' },
                    { name: 'Обсуждение повестки', duration: 1200, color: 'bg-green-400', activeColor: '#34d399' },
                    { name: 'Промежуточные итоги', duration: 300, color: 'bg-green-500', activeColor: '#10b981' },
                    { name: 'Финальные итоги', duration: 240, color: 'bg-orange-400', activeColor: '#fb923c' },
                    { name: 'Новый план действий', duration: 240, color: 'bg-orange-500', activeColor: '#f97316' },
                    { name: 'Обратная связь', duration: 120, color: 'bg-orange-600', activeColor: '#ea580c' }
                ]);
                
                // Подсказка
                const tooltipVisible = ref(false);
                const tooltipText = ref('');
                const tooltipX = ref(0);
                const tooltipY = ref(0);
                
                // Вычисляемые свойства
                const progress = computed(() => (currentTime.value / totalTime.value) * 100);
                
                const stagesWithAngles = computed(() => {
                    let cumulativeDuration = 0;
                    return stages.value.map(stage => {
                        const startAngle = (cumulativeDuration / totalTime.value) * 360 - 90;
                        cumulativeDuration += stage.duration;
                        const endAngle = (cumulativeDuration / totalTime.value) * 360 - 90;
                        return { ...stage, startAngle, endAngle };
                    });
                });
                
                const currentStageIndex = computed(() => {
                    let elapsed = currentTime.value;
                    let total = 0;
                    for (let i = 0; i < stages.value.length; i++) {
                        total += stages.value[i].duration;
                        if (elapsed < total) {
                            return i;
                        }
                    }
                    return stages.value.length - 1;
                });
                
                const currentStageName = computed(() => {
                    return stages.value[currentStageIndex.value]?.name || 'Завершено';
                });
                
                const remainingTimeInStage = computed(() => {
                    let elapsed = currentTime.value;
                    let stageStart = 0;
                    
                    for (let i = 0; i < currentStageIndex.value; i++) {
                        stageStart += stages.value[i].duration;
                    }
                    
                    const stageDuration = stages.value[currentStageIndex.value]?.duration || 0;
                    const timeInStage = elapsed - stageStart;
                    return Math.max(0, stageDuration - timeInStage);
                });
                
                // Методы
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                };
                
                const startTimer = () => {
                    if (currentTime.value >= totalTime.value) {
                        resetTimer();
                    }
                    
                    isRunning.value = true;
                    timer.value = setInterval(() => {
                        currentTime.value += 1;
                        
                        if (currentTime.value >= totalTime.value) {
                            pauseTimer();
                            currentTime.value = totalTime.value;
                        }
                    }, 1000);
                };
                
                const pauseTimer = () => {
                    isRunning.value = false;
                    clearInterval(timer.value);
                };
                
                const resetTimer = () => {
                    pauseTimer();
                    currentTime.value = 0;
                };
                
                const getCoordinate = (angle, radius) => {
                    const rad = (angle * Math.PI) / 180;
                    return {
                        x: 50 + radius * Math.cos(rad),
                        y: 50 + radius * Math.sin(rad)
                    };
                };
                
                const getPathString = (startAngle, endAngle) => {
                    const start = getCoordinate(startAngle, 45);
                    const end = getCoordinate(endAngle, 45);
                    const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
                    return `M 50 50 L ${start.x} ${start.y} A 45 45 0 ${largeArc} 1 ${end.x} ${end.y} Z`;
                };
                
                const showTooltip = (stage, event) => {
                    tooltipText.value = `${stage.name}: ${formatTime(stage.duration)}`;
                    tooltipX.value = event.pageX + 10;
                    tooltipY.value = event.pageY + 10;
                    tooltipVisible.value = true;
                };
                
                const hideTooltip = () => {
                    tooltipVisible.value = false;
                };
                
                // Автоматическая очистка таймера при уничтожении компонента
                onUnmounted(() => {
                    clearInterval(timer.value);
                });
                
                return {
                    totalTime,
                    currentTime,
                    isRunning,
                    stages,
                    stagesWithAngles,
                    currentStageIndex,
                    currentStageName,
                    remainingTimeInStage,
                    progress,
                    tooltipVisible,
                    tooltipText,
                    tooltipX,
                    tooltipY,
                    formatTime,
                    startTimer,
                    pauseTimer,
                    resetTimer,
                    getPathString,
                    showTooltip,
                    hideTooltip
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
